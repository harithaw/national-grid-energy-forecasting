# ⚡ Sri Lanka National Grid – Energy Forecasting

[![Open in Streamlit](https://static.streamlit.io/badges/streamlit_badge_black_white.svg)](https://national-grid-energy-forecasting-214245a.streamlit.app/)

> **Live dashboard → [national-grid-energy-forecasting-214245a.streamlit.app](https://national-grid-energy-forecasting-214245a.streamlit.app/)**

A machine-learning pipeline that forecasts daily electricity generation on the Sri Lanka national grid up to 90 days ahead, broken down by energy source. Built with LightGBM (via Darts), Optuna hyperparameter tuning, SHAP explainability, and an interactive Streamlit dashboard.

---

## Features

- **90-day daily generation forecast** – total GWh/day split across Solar, Hydro, Wind, Biomass, Oil, and Coal
- **80% confidence band** – quantile regression (p10 / p50 / p90) powered by `likelihood="quantile"` + 500-sample Monte Carlo for multi-step horizons
- **Rolling retrain** – model retrains every 30 days on the most recent 760-day window, adapting to structural shifts
- **SHAP explainability** – global feature importance (beeswarm) and a local explanation for the most recent prediction
- **Optuna hyperparameter tuning** – persistent SQLite study, resumable at any time
- **Interactive dashboard** – stacked bar chart with CI overlay, residuals, monthly aggregation, and scatter plot

---

## Project Structure

```
├── forecast.py            # Main pipeline orchestrator (run this)
├── config.py              # Shared constants (paths, horizon)
├── preprocess.py          # Data loading & feature engineering
├── model_setup.py         # LightGBMModel construction & data splits
├── train_evaluate.py      # Training, rolling evaluation, plots
├── explainability.py      # SHAP summary & local explanations
├── future_forecast.py     # 90-day forward forecast generation
├── tune_hyperparams.py    # Optuna tuning (run separately)
├── app.py                 # Streamlit dashboard
├── data/
│   └── merged-generation-profile-2017-2026.csv
└── artifacts/             # Generated by forecast.py (gitignored)
    ├── model.pkl
    ├── best_hyperparams.json
    ├── future_forecast.csv
    ├── test_predictions.csv
    ├── metrics.json
    └── *.png
```

---

## Quickstart

### 1. Create & activate the virtual environment

```bash
python -m venv venv
.\venv\Scripts\Activate.ps1        # Windows PowerShell
# source venv/bin/activate         # macOS / Linux
```

### 2. Install dependencies

```bash
pip install darts lightgbm optuna shap streamlit plotly pandas numpy matplotlib
```

### 3. (Optional) Tune hyperparameters

```bash
python tune_hyperparams.py --trials 30
# Resume an existing study:
python tune_hyperparams.py --resume --trials 30
```

### 4. Run the full pipeline

```bash
python forecast.py
```

Trains the model, evaluates on the 2025–2026 test set, generates the 90-day forward forecast, runs SHAP, and saves all artifacts to `artifacts/`.

### 5. Launch the dashboard

```bash
.\venv\Scripts\streamlit.exe run app.py
```

---

## Docker

A `Dockerfile` and `entrypoint.sh` are included. On first start the container runs `forecast.py` automatically (takes ~5 min); artifacts are cached in a named volume so subsequent starts are instant.

### Build

```bash
docker build -t grid-forecast .
```

### Run

```bash
docker run -p 8501:8501 -v grid-artifacts:/app/artifacts grid-forecast
```

Then open [http://localhost:8501](http://localhost:8501).

The named volume `grid-artifacts` persists the trained model, forecast CSV, and plots between container restarts. To force a full retrain, remove the volume:

```bash
docker volume rm grid-artifacts
```

### Run the tuner inside the container

```bash
docker run --rm -v grid-artifacts:/app/artifacts grid-forecast \
    python tune_hyperparams.py --trials 30
```

---

## Model Overview

| Item | Detail |
|---|---|
| Algorithm | LightGBM (`darts.models.LightGBMModel`) |
| Likelihood | Quantile regression — p10 / p50 / p90 |
| Target | `Total_Generation` (GWh/day) |
| Train period | 2017-01-01 – 2023-12-31 |
| Validation | 2024 (single year hold-out) |
| Test period | 2025-01-01 – 2026-02-22 |
| Test RMSE | ~2.99 GWh/day |
| Test MAE | ~2.02 GWh/day |
| Test MAPE | ~3.99 % |
| R² | ~0.786 |
| Key features | `YoY_Delta`, `Roll365_Mean`, lag features (−1 d to −365 d) |
| Retrain strategy | Rolling window — 760-day train length, stride 30 days |

---

## Data Source

Daily generation data from the **Public Utilities Commission of Sri Lanka (PUCSL)** covering January 2017 – February 2026. Columns include metered and estimated readings for Solar (rooftop + utility), Mini Hydro, Major Hydro, Wind, Biomass & Waste, Oil (IPP & CEB), and Coal.
